<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Force based label placement</title>
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background-color: rgba(30, 90, 198, .2);
    }

    .search-node {
      position: absolute;
      background: none;
      top: 3%;
      right: 3%;
      border: 1px solid #689ba5;
      border-radius: 10px;
      width: 20%;
    }

    .search-node input {
      background: none;
      border: none;
      padding: 3%;
      width: 100%;
      font-family: "-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif";
      font-size: 20px;
      color: rgb(70, 70, 70)
    }

    input:focus,
    select:focus,
    textarea:focus,
    button:focus {
      outline: none;
    }
  </style>
</head>

<body>
  <!-- added this to allow search of nodes -->
  <div class="search-node">
    <input type="text" id="search-node" placeholder="Who are you looking for?">
  </div>
  <script type="text/javascript" charset="utf-8">
    var w = document.body.clientWidth, h = document.body.clientHeight;

    var labelDistance = 0;

    // Definition of body and svg
    // Definition of zoom and remove double click to zoom
    var vis1 = d3.select("body").append("svg:svg").attr("width", w).attr("height", h).call(d3.zoom().on("zoom", function () {
      vis.attr("transform", d3.event.transform);
    }
    )).on("dblclick.zoom", null);

    var vis = vis1.append("g");


    // Initialization of variables
    var nodes = [];
    var nodeElements;
    var links = [];


    var selected = null;


    
    var nodes_total = [{ "id": 1, "label": "Ladislau Roque Pinto" }, { "id": 2, "label": "Alzira Maria Neto" }, { "id": 3, "label": "Lurdes Neto Pinto" }, { "id": 4, "label": "Gracinda Neto Pinto" }, { "id": 5, "label": "Lucilia Neto Pinto" }, { "id": 6, "label": "Ana Neto Pinto" }, { "id": 7, "label": "Emilia Neto Pinto" }, { "id": 8, "label": "Fatima Neto Pinto" }, { "id": 9, "label": "Cristina Neto Pinto" }, { "id": 10, "label": "Carla Sofia Neto Pinto" }, { "id": 11, "label": "Augusto Gil" }, { "id": 12, "label": "Pedro Gil" }, { "id": 13, "label": "Cecilia Gil" }, { "id": 14, "label": "Jessica Gil" }, { "id": 15, "label": "Armando Pereira Tomé" }, { "id": 16, "label": "Samuel Neto Pereira" }, { "id": 17, "label": "Marisa Neto Pereira" }, { "id": 18, "label": "Alberto Pires Monteiro" }, { "id": 19, "label": "Dina Pinto Monteiro" }, { "id": 20, "label": "Micael Neto Pires" }, { "id": 21, "label": "Antonio Monteiro" }, { "id": 22, "label": "Viviane Monteiro" }, { "id": 23, "label": "Sara Monteiro" }, { "id": 24, "label": "Jorge Esteves" }, { "id": 25, "label": "Marco Pinto Esteves" }, { "id": 26, "label": "Jorge Gabriel Pinto Esteves" }, { "id": 27, "label": "Carlos Vieira" }, { "id": 28, "label": "Fabio Pinto Vieira" }, { "id": 30, "label": "Pedro Picao" }, { "id": 31, "label": "Tiago Picao" }, { "id": 32, "label": "Martim Picao" }, { "id": 33, "label": "Agostinho Lucas Martins" }, { "id": 34, "label": "Edgar Neto Martins" }, { "id": 35, "label": "Martim Picao" }, { "id": 36, "label": "Bruno Alfaiate" }, { "id": 37, "label": "Sofia Monteiro Alfaiate" }, { "id": 38, "label": "Clara Monteiro Alfaiate" }, { "id": 39, "label": "François" }, { "id": 40, "label": "Julia Gil" }];

    var links_total = [{ "source": 1, "target": 2, "type": "union", "strength": 5, "weight": 0.9 },
    { "source": 2, "target": 1, "type": "union", "strength": 5, "weight": 0.9 },
    { "source": 1, "target": 3, "type": "children", "strength": 0.2, "weight": 0.9 },
    { "source": 2, "target": 3, "type": "children", "strength": 0.2, "weight": 0.9 },
    { "source": 1, "target": 4, "type": "children", "strength": 0.2, "weight": 0.9 },
    { "source": 2, "target": 4, "type": "children", "strength": 0.2, "weight": 0.9 },
    { "source": 1, "target": 5, "type": "children", "strength": 0.2, "weight": 0.9 },
    { "source": 2, "target": 5, "type": "children", "strength": 0.2, "weight": 0.9 },
    { "source": 1, "target": 6, "type": "children", "strength": 0.2, "weight": 0.9 },
    { "source": 2, "target": 6, "type": "children", "strength": 0.2, "weight": 0.9 },
    { "source": 1, "target": 7, "type": "children", "strength": 0.2, "weight": 0.9 },
    { "source": 2, "target": 7, "type": "children", "strength": 0.2, "weight": 0.9 },
    { "source": 1, "target": 8, "type": "children", "strength": 0.2, "weight": 0.9 },
    { "source": 2, "target": 8, "type": "children", "strength": 0.2, "weight": 0.9 },
    { "source": 1, "target": 9, "type": "children", "strength": 0.2, "weight": 0.9 },
    { "source": 2, "target": 9, "type": "children", "strength": 0.2, "weight": 0.9 },
    { "source": 1, "target": 10, "type": "children", "strength": 0.2, "weight": 0.9 },
    { "source": 2, "target": 10, "type": "children", "strength": 0.2, "weight": 0.9 },
    { "source": 3, "target": 11, "type": "union", "strength": 5, "weight": 0.9 },
    { "source": 11, "target": 3, "type": "union", "strength": 5, "weight": 0.9 },
    { "source": 3, "target": 12, "type": "children", "strength": 0.2, "weight": 0.9 },
    { "source": 11, "target": 12, "type": "children", "strength": 0.2, "weight": 0.9 },
    { "source": 3, "target": 13, "type": "children", "strength": 0.2, "weight": 0.9 },
    { "source": 11, "target": 13, "type": "children", "strength": 0.2, "weight": 0.9 },
    { "source": 3, "target": 14, "type": "children", "strength": 0.2, "weight": 0.9 },
    { "source": 11, "target": 14, "type": "children", "strength": 0.2, "weight": 0.9 },
    { "source": 4, "target": 15, "type": "union", "strength": 5, "weight": 0.9 },
    { "source": 15, "target": 4, "type": "union", "strength": 5, "weight": 0.9 },
    { "source": 4, "target": 16, "type": "children", "strength": 0.2, "weight": 0.9 },
    { "source": 15, "target": 16, "type": "children", "strength": 0.2, "weight": 0.9 },
    { "source": 4, "target": 17, "type": "children", "strength": 0.2, "weight": 0.9 },
    { "source": 15, "target": 17, "type": "children", "strength": 0.2, "weight": 0.9 },
    { "source": 5, "target": 18, "type": "union", "strength": 5, "weight": 0.9 },
    { "source": 18, "target": 5, "type": "union", "strength": 5, "weight": 0.9 },
    { "source": 5, "target": 19, "type": "children", "strength": 0.2, "weight": 0.9 },
    { "source": 18, "target": 19, "type": "children", "strength": 0.2, "weight": 0.9 },
    { "source": 5, "target": 20, "type": "children", "strength": 0.2, "weight": 0.9 },
    { "source": 18, "target": 20, "type": "children", "strength": 0.2, "weight": 0.9 },
    { "source": 6, "target": 21, "type": "union", "strength": 5, "weight": 0.9 },
    { "source": 21, "target": 6, "type": "union", "strength": 1, "weight": 0.9 },
    { "source": 6, "target": 22, "type": "children", "strength": 0.2, "weight": 0.9 },
    { "source": 21, "target": 22, "type": "children", "strength": 0.2, "weight": 0.9 },
    { "source": 6, "target": 23, "type": "children", "strength": 0.2, "weight": 0.9 },
    { "source": 21, "target": 23, "type": "children", "strength": 0.2, "weight": 0.9 },
    { "source": 7, "target": 24, "type": "union", "strength": 1, "weight": 0.9 },
    { "source": 24, "target": 7, "type": "union", "strength": 1, "weight": 0.9 },
    { "source": 7, "target": 25, "type": "children", "strength": 0.2, "weight": 0.9 },
    { "source": 24, "target": 25, "type": "children", "strength": 0.2, "weight": 0.9 },
    { "source": 7, "target": 26, "type": "children", "strength": 0.2, "weight": 0.9 },
    { "source": 24, "target": 26, "type": "children", "strength": 0.2, "weight": 0.9 },
    { "source": 8, "target": 27, "type": "union", "strength": 1, "weight": 0.9 },
    { "source": 27, "target": 8, "type": "union", "strength": 1, "weight": 0.9 },
    { "source": 8, "target": 28, "type": "children", "strength": 0.2, "weight": 0.9 },
    { "source": 27, "target": 28, "type": "children", "strength": 0.2, "weight": 0.9 },
    { "source": 9, "target": 30, "type": "union", "strength": 1, "weight": 0.9 },
    { "source": 30, "target": 9, "type": "union", "strength": 1, "weight": 0.9 },
    { "source": 9, "target": 31, "type": "children", "strength": 0.2, "weight": 0.9 },
    { "source": 30, "target": 31, "type": "children", "strength": 0.2, "weight": 0.9 },
    { "source": 9, "target": 32, "type": "children", "strength": 0.2, "weight": 0.9 },
    { "source": 30, "target": 32, "type": "children", "strength": 0.2, "weight": 0.9 },
    { "source": 10, "target": 33, "type": "union", "strength": 1, "weight": 0.9 },
    { "source": 33, "target": 10, "type": "union", "strength": 1, "weight": 0.9 },
    { "source": 10, "target": 34, "type": "children", "strength": 0.2, "weight": 0.9 },
    { "source": 33, "target": 34, "type": "children", "strength": 0.2, "weight": 0.9 },
    { "source": 10, "target": 35, "type": "children", "strength": 0.2, "weight": 0.9 },
    { "source": 33, "target": 35, "type": "children", "strength": 0.2, "weight": 0.9 },
    { "source": 19, "target": 36, "type": "union", "strength": 1, "weight": 0.9 },
    { "source": 36, "target": 19, "type": "union", "strength": 1, "weight": 0.9 },
    { "source": 19, "target": 37, "type": "children", "strength": 0.2, "weight": 0.9 },
    { "source": 36, "target": 37, "type": "children", "strength": 0.2, "weight": 0.9 },
    { "source": 19, "target": 38, "type": "children", "strength": 0.2, "weight": 0.9 },
    { "source": 36, "target": 38, "type": "children", "strength": 0.2, "weight": 0.9 },
    { "source": 13, "target": 39, "type": "union", "strength": 1, "weight": 0.9 },
    { "source": 39, "target": 13, "type": "union", "strength": 1, "weight": 0.9 },
    { "source": 13, "target": 40, "type": "children", "strength": 0.2, "weight": 0.9 },
    { "source": 39, "target": 40, "type": "children", "strength": 0.2, "weight": 0.9 }];



    // Credits to https://bl.ocks.org/mapio/53fed7d84cd1812d6a6639ed7aa83868

    // first definition of filtered nodes (no filter)
    var nodes = nodes_total
    var links = links_total

    // defition of a dictionary to map id of node to index
    var nodesbyid = {}
    for (var i = 0; i < nodes_total.length; i++) {
      nodesbyid[
        nodes_total[i]["id"]] = i
    }

    // adjency lists to help verification of neighbors
    var adjlist = {};
    var adjlist_node = {};
    for (var i = 0; i < links_total.length; i++) {
      adjlist[nodesbyid[links_total[i].source] + "-" + nodesbyid[links_total[i].target]] = true;
      adjlist[nodesbyid[links_total[i].target] + "-" + nodesbyid[links_total[i].source]] = true;
      links_total[i].source = nodesbyid[links_total[i].source];
      links_total[i]["id"] = i;
      links_total[i].target = nodesbyid[links_total[i].target];
    };


    // Initialization of D3 Force Simulation
    // var labelLayout = d3.forceSimulation()
    //   .force("charge", d3.forceManyBody().strength(-60))

    var graphLayout = d3.forceSimulation()
      .force("charge", d3.forceManyBody().strength(-3000))
      .force("center", d3.forceCenter(w / 2, h / 2))
      .force("x", d3.forceX(w / 2).strength(1))
      .force("y", d3.forceY(h / 2).strength(1))

    
    // Defition of drag 
    var node_drag = d3.drag()
      .on("start", dragstarted)
      .on("drag", dragged)
      .on("end", dragended);

    // Initialization of SVG Elements 
    var linkElements = vis.append("g")
      .attr("class", "links")
      .selectAll("line")

    var nodeElements = vis.append("g")
      .attr("class", "node")
      .selectAll(".node")


    // var labelNode = vis.append("g").attr("class", "labelNodes")
    //   .selectAll("text")


    // Function that produces the svg per se-
    update()

    
    function update() {

      // Definition of label of nodes
      var label = {
        'nodes': [],
        'links': []
      };

      nodes.forEach(function (d, i) {
        label.nodes.push({ node: d, id: d.id * 2 });
        label.nodes.push({ node: d, id: d.id * 2 + 1 });
        label.links.push({
          source: i * 2,
          target: i * 2 + 1,
          id: i * 2
        });
      });


      // Remove elements that are eliminated by filter
      linkElements = linkElements.data(links, function (d) { return d });
      linkElements.exit().remove();

      // Insert new elements
      var newlinkElements = linkElements.enter().append("line")
        .attr("stroke-width", 5)
        .attr("stroke", function (d) { return colorstandartlink(d) });
      
      // Update elements 
      linkElements = linkElements.merge(newlinkElements)

      // Remove elements that are eliminated by filter
      nodeElements = nodeElements.data(nodes);
      nodeElements.exit().remove();

      // Insert new elements
      var newnodeElements = nodeElements.enter()
      .append("g")
      .attr("class", "node")
      .on('click', selectNode) // Select Node
        .on("dblclick", dblclick) // Add neighbords in filtered views
        .on("contextmenu", lftclick) // Remove fixed position
        .call(node_drag) // Allow drag of node

      newnodeElements.append("circle")
        .attr("r", 12)  
        .attr("fill", getNodeColor) // Color nodes
        
    
    newnodeElements.append("text")
        .attr("dx", 12)
        .attr("dy", ".35em")
        .text(function(d) {return d.label });

      // Update elements 
      nodeElements = nodeElements.merge(newnodeElements)

      // Allow Focus of nodes
      nodeElements.on("mouseover", focus).on("mouseout", unfocus);



      // Remove elements that are eliminated by filter
      // labelNode = labelNode.data(label.nodes, function (d) { return d.id; });
      // labelNode.exit().remove();


      // Insert new elements
      // var newlabelNode = labelNode.enter()
      //   .append("text")
      //   .text(function (d, i) { return i % 2 == 0 ? "" : d.node.label; })
      //   .style("fill", "#555")
      //   .style("font-family", "Arial")
      //   .style("font-size", 12)
      //   .style("pointer-events", "none"); // to prevent mouseover/drag capture. This means that you cannot copy text (unless you go to the console)


      // Update elements 
      // labelNode = labelNode.merge(newlabelNode)


      // Define nodes and links in the graph and restart force simulation 
      graphLayout.nodes(nodes);
      graphLayout.force("link", d3.forceLink(links).id(function (d) { return d.index; }).distance(50).strength(1))
      graphLayout.on("tick", ticked)
      graphLayout.restart();

      // Define label nodes and links in the graph and restart force simulation
      // labelLayout.nodes(label.nodes);
      // labelLayout.force("link", d3.forceLink(label.links).distance(10).strength(2));
      // labelLayout.on("tick", ticked)
      // labelLayout.restart();

    }

    // Function that defines the location of each element in the SVG
    function ticked() {
      // Define location of Nodes 
      nodeElements.call(updateNode);
      // Define location of Links 
      linkElements.call(updateLink);

      // Define location of Label Nodes 
      // labelLayout.alphaTarget(0.3).restart();
      // labelNode.each(function (d, i) {
      //   if (i % 2 == 0) {
      //     // If node on the left of the screen push the label to the left of the node
      //     if (d.node.x < w / 2) {
      //       d.x = d.node.x - Math.min(d.node.label.length * 9 * (w / 2 - d.node.x) / (w / 2), d.node.label.length * 5)
      //     } else {
      //       d.x = d.node.x;
      //     }

      //     d.y = d.node.y;
      //   } else {
      //     var b = this.getBBox();    

      //     var diffX = d.x - d.node.x;
      //     var diffY = d.y - d.node.y;

      //     var dist = Math.sqrt(diffX * diffX + diffY * diffY);

      //     var shiftX = b.width * (diffX - dist) / (dist * 2);
      //     shiftX = Math.max(-b.width, Math.min(0, shiftX));
      //     var shiftY = 16;
      //     this.setAttribute("transform", "translate(" + shiftX + "," + shiftY + ")");
      //   }
      // });
      // labelNode.call(updateNode);

    }

    // Search for unions
    function getUnion(node) {
      return links.reduce(function (union, link) {
        if (link.type === "union" && (link.target.id === node.id || link.source.id === node.id)) {
          union.push(link.target.id)
        }
        return union
      },
        [node.id]
      )
    }

    // Function that retrieve children of node
    function getChildren(node) {
      return links.reduce(function (children, link) {
        if (link.source.id === node.id && link.type === "children") {
          children.push(link.target.id)
        }
        return children
      },
        []
      )
    }

    // Function that retrieve parents of node
    function getParents(node) {
      return links.reduce(function (parents, link) {
        if (link.target.id === node.id && link.type === "children") {
          parents.push(link.source.id)
        }
        return parents
      },
        []
      )
    }

    // Function that indicates if a link is of a specified node
    function isNeighborLink(node, link) {
      if (node === null) {
        return false;
      }
      return link.target.id === node.id || link.source.id === node.id
    }

    // Function that colors nodes
    function getNodeColor(node, union, children, parents) {
      if (Array.isArray(union) && Array.isArray(children) && Array.isArray(parents)) {
        return union.indexOf(node.id) > -1 ? '#fbb831' : '#689ba5' && children.indexOf(node.id) > -1 ? '#5bc8c1' : '#689ba5' && parents.indexOf(node.id) > -1 ? '#aaba6a' : '#689ba5'
      } else { return '#689ba5' }
    }


    // Standard colors of links
    function colorstandartlink(link) {
      if (link.type === 'union') {
        return "#ba6a6a";
      } else {
        return "rgba(50, 50, 50, 0.2)";
      }
    }

    // Function that colors links
    function getLinkColor(node, link) {
      if (isNeighborLink(node, link)) {
        if (link.type === 'union') {
          return "#ba6a6a";
        }
        else {
          return "#aaba6a"
        }
      }
      else {
        return colorstandartlink(link)
      }
    }

    // Function that colors text
    function getTextColor(node, union, children, parents) {
      if (Array.isArray(union) && Array.isArray(children) && Array.isArray(parents)) {
        return union.indexOf(node.id) > -1 ? '#fbb831' : 'black' && children.indexOf(node.id) > -1 ? '#aaba6a' : 'black' && parents.indexOf(node.id) > -1 ? '#aaba6a' : 'black'
      } else {
        return "black";
      }
    }

    // Function that selects a node and colors its neighborhood
    function selectNode(selectedNode) {
      if (selected === selectedNode) {
        selected = null;
        var union = null;
        var children = null;
        var parents = null;
        // we modify the styles to undo highlight
        nodeElements.attr('fill', function (node) { return getNodeColor(node, union, children, parents) })
        // nodeElements.label.style('fill', function (node) { return getTextColor(node, union, children, parents) })
        linkElements.attr('stroke', function (link) { return getLinkColor(selected, link) })
      } else {
        var union = getUnion(selectedNode);
        var children = getChildren(selectedNode);
        var parents = getParents(selectedNode);
        // we modify the styles to highlight selected nodes
        nodeElements.attr('fill', function (node) { return getNodeColor(node, union, children, parents) })
        // nodeElements.label.style('fill', function (node) { return getTextColor(node, union, children, parents) })
        linkElements.attr('stroke', function (link) { return getLinkColor(selectedNode, link) })
        selected = selectedNode;
      }
    }


    // Function that retrieves the data from the input text form and applies a automatic filter
    var input = document.querySelector('#search-node');
    input.addEventListener('input', function () {
      if (input.value === "" || !input.value) {
        nodes = nodes_total
        links = links_total
      } else {
        // Filter nodes
        var aux = regex_search(nodes_total, input.value)
        nodes = aux[0]
        var nodes_ids = aux[1]
        // nodes, nodes_ids = regex_search(nodes_total, input.value)
        // Retrieve links of given nodes
        links = filter_links_by_nodes(links_total, nodes_ids)
      }
      // Update graph
      update()
    });


    // Regex search through nodes names
    function regex_search(nodes_list, search_string) {
      let re = new RegExp(search_string, "ig");
      let new_nodes = []
      let new_nodes_ids = []
      for (var i = 0; i < nodes_list.length; i++) {
        if (nodes_list[i].label.search(re) > -1) {
          new_nodes.push(nodes_list[i])
          new_nodes_ids.push(nodes_list[i].id)
        }
      }
      return [new_nodes, new_nodes_ids]
    }

    // Search of links of given nodes ids
    function filter_links_by_nodes(links_list, nodes_list) {
      let new_list = links_list.filter(function (link) {
        if (nodes_list.includes(link.source.id) && nodes_list.includes(link.target.id)) {
          return true
        }
        else {
          return false
        }
      })
      return new_list
    }

    // On double click add neighbor nodes if not present and respective links
    function dblclick(d) {
      var index = d3.select(d3.event.target).datum().id;
      let new_nodes_ids = nodes.map(function (node) { return node.id })
      for (var i = 0; i < nodes_total.length; i++) {
        if (!new_nodes_ids.includes(nodes_total[i].id) && neigh(nodesbyid[index], nodesbyid[nodes_total[i].id])) {
          nodes.push(nodes_total[i])

          new_nodes_ids.push(nodes_total[i].id)
        }
      }
      links = filter_links_by_nodes(links_total, new_nodes_ids)
      update()
    }

    // Remove the fixed position of a node after drag 
    function lftclick(d, i) {
      d3.event.preventDefault();
      if (d.fixed) {
        d.fx = null;
        d.fy = null;
        d3.select(this).classed("fixed", d.fixed = false);
      }
    }

    // Start Drag of node
    function dragstarted(d) {
      d3.event.sourceEvent.stopPropagation();
      if (!d3.event.active) graphLayout.alphaTarget(0.3).restart();
      d.fx = d.x;
      d.fy = d.y;
    }

    // middle of drag 
    function dragged(d) {
      d.fx = d3.event.x;
      d.fy = d3.event.y;
    }

    // End drag of node
    function dragended(d) {
      if (!d3.event.active) graphLayout.alphaTarget(0);
      d.fixed = true;
    }

    // Function that indicated if two node index are neighbors
    function neigh(a, b) {
      return a == b || adjlist[a + "-" + b];
    }

    // Function that compensated overflow and Nan
    function fixna(x) {
      if (isFinite(x)) return x;
      return 0;
    }

    // Function that highlights neighbor nodes and links
    function focus(d) {
      var index = d3.select(d3.event.target).datum().index;
      nodeElements.style("opacity", function (o) {
        return neigh(index, o.index) ? 1 : 0.1;
      });
      // labelNode.attr("display", function (o) {
      //   return neigh(index, o.node.index) ? "block" : "none";
      // });
      linkElements.style("opacity", function (o) {
        return o.source.index == index || o.target.index == index ? 1 : 0.1;
      });
    }

    // Remove focus of node
    function unfocus() {
      // labelNode.attr("display", "block");
      nodeElements.style("opacity", 1);
      linkElements.style("opacity", 1);
    }

    // Update position of links
    function updateLink(link) {
      link.attr("x1", function (d) { return fixna(d.source.x); })
        .attr("y1", function (d) { return fixna(d.source.y); })
        .attr("x2", function (d) { return fixna(d.target.x); })
        .attr("y2", function (d) { return fixna(d.target.y); });
    }
    // Update position of nodes
    function updateNode(node) {
      node.attr("transform", function (d) {
        return "translate(" + fixna(d.x) + "," + fixna(d.y) + ")";
      });
    }





  </script>

</body>

</html>